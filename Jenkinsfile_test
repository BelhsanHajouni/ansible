pipeline {
    agent any

   environment {
       VAULT_PASS = credentials('ansible_vault_password') // Use your credentials ID
    }



    tools {
        ansible 'Ansible'
    }
    stages {
        stage('Git Checkout') {
            steps {
                echo 'Pulling ... '
                git branch: 'main',
                url: 'https://github.com/jasminemansouri/ansible'
            }
        }
        stage('Prepare') {
            steps {
                script {
                    // Write the Vault password to a file
                    writeFile filePath: 'vault-password.txt', text: env.VAULT_PASS
                    // Set appropriate permissions for the password file
                    sh 'chmod 600 vault-password.txt'
                    echo "***************************************"
                     // Use the cat command to read the file contents
                    def fileContents = sh(script: "cat ${filePath}", returnStdout: true).trim()

                    // Display the file contents in the Jenkins console
                    echo "Contents of ${filePath}:\n${fileContents}"
                }
            }
        }
        stage('Run Ansible Playbook') {
            steps {
                script {
                    // Run the Ansible playbook with the Vault password file
                    sh 'ansible-playbook -i hosts.ini test.yml --vault-password-file vault-password.txt'
                }
            }
        }

    }
post {
        cleanup {
            // Clean up the Vault password file after the job
            sh 'rm -f vault-password.txt'
        }
    }
}
