pipeline {
    agent any

    environment {
        VAULT_PASS = credentials('ansible_vault_password')
        SSH_KEY = credentials('ssh_private_key') // Assuming you store the private key in Jenkins credentials
    }

    tools {
        ansible 'Ansible'
    }

    stages {
        stage('Git Checkout') {
            steps {
                echo 'Pulling ...'
                git branch: 'main',
                url: 'https://github.com/jasminemansouri/ansible'
            }
        }

        stage('Test') {
            steps {
                withCredentials([string(credentialsId: 'ansible_vault_password', variable: 'VAULT_PASS'), 
                                 file(credentialsId: 'ssh_private_key', variable: 'SSH_KEY_FILE')]) {
                    script {
                        // Write the vault password to a temporary file within the Jenkins workspace
                        writeFile file: 'vault_password.txt', text: env.VAULT_PASS

                        // Ensure the SSH private key file has the correct permissions
                        sh 'chmod 600 ' + SSH_KEY_FILE

                        // Run Ansible playbook, referencing the temporary vault password file and SSH key
                        sh """
                            ansible-playbook -i hosts.ini test.yml --vault-password-file vault_password.txt \
                            --private-key ${SSH_KEY_FILE}
                        """

                        // Clean up the temporary vault password file
                        sh 'rm -f vault_password.txt'
                    }
                }
            }
        }
    }
}
